---
title:  "Demystifying AWS IAM Identity Center: How It Works with AWS CLI"
seo_title: "demystifying aws iam identity center: how it works with aws cli"
seo_description: "demystifying aws iam identity center: how it works with aws cli"
date:   2025-04-04 00:00:00 +0700
categories:
  - Programming
tags:
  - AWS
excerpt: "This post details the AWS CLI login flow."
toc: true
toc_label: "Table of Contents"
---
### Overview
I've been working with [K9S](https://k9scli.io/) for the past couple weeks in a secured AWS environment which only permits user with a certain level of privileges to access the EKS API. K9S work by leveraging the kubernetes context which is generated when you run the following AWS CLI command: `aws eks --region <region_name> update-kubeconfig --name <eks_cluster_name> --profile <aws_profile_name>`. This command requires your AWS CLI to be authenticated to use AWS resources. To authenticate my AWS CLI, my platform team requires users to generate all the required AWS configuration files by going through several steps of account login using AWS IAM Identity Center (successor to AWS Single Sign-On) OpenID Connect (OIDC): a web service that enables a client (such as AWS CLI or a native application) to register with IAM Identity Center. 

Authenticating using IAM Identity center involves a combination of navigating the browser, using Multi-Factor Authentication to validate my privileges, and copy-paste of many texts generated by the SSO web page to my laptop. As a CLI junkie and Rust enthusiasts, I decided to develop a CLI tool to streamline the steps by by leveraging the AWS SDK for Rust. Along the way, I've learned many lessons on how exactly the AWS SSO credentials work with those configuration files, which I am sharing in this post. 

### How IAM Identity Center OIDC Service Works
IAM Identity Center is a service for connecting users to AWS resources. We can connect our existing identity provider (e.g. Active Directory) and synchronize users and groups from our directory to do either or both of the following:

1. User access to applications
2. User access to AWS accounts

The IAM Identity Center OIDC service currently implements only the portions of the OAuth 2.0 Device Authorization Grant standard ( https://tools.ietf.org/html/rfc8628 ) that are necessary to enable single sign-on authentication with the AWS CLI. 

The service emits only OIDC access tokens, such that obtaining a new token (For example, token refresh) requires explicit user re-authentication.

The access tokens provided by this service grant access to all AWS account entitlements assigned to an IAM Identity Center user, not just a particular application.

### Description
AWS CLI invocation:

1. (Primary) AWS Config file -> `~/.aws/config`:
	a. check profile and its sso profile & role name.
	b. (might be invalid) check cli cache file -> `~/.aws/cli/cache/<cache>.json`
		i. content of this file can be the same with `~/.aws/credentials`
		ii. but make sure it is using CamelCase formatting for the keys!
			- use the `#[serde(rename_all = "PascalCase")]` directive for the struct.
			- and use the `#[serde(rename = "PascalCase")]` for the attribute
	c. check the token cache -> `~/.aws/sso/cache/<filename>.json`
		i. note: <filename> must be the sha1 hash version of the session name registered under the profile you are using.
		ii. for example, suppose that you have the following entry in your `~/.aws/config` file, and let's say you want to invoke the following AWS CLI command: `aws s3 ls --profile icloud-dev`:

			{% highlight bash %}
			[sso-session sso-d-9367052e24]
			sso_start_url=https://d-9367052e24.awsapps.com/start/#
			sso_registration_scopes=sso:account:access
			sso_region=eu-west-1

			[profile icloud-dev]
			sso_account_id=291751643970
			sso_session=sso-d-9367052e24 --> the cache filename must be the sha1 hash version of sso_session name!
			sso_role_name=tlz_developer
			region=eu-west-1
			{% endhighlight %}  

			Then you need to have the cache file following this syntax = `~/.aws/sso/cache/$(sha1::from("sso-d-9367052e24")).json` 
			
			i.e., `~/.aws/sso/cache/7a7d2bddd4a31e7b4be4c83fdbbe1af869b642f8.json`

2. (Fallback) AWS Credentials file -> `~/.aws/credentials`:
	a. check if AWS access key ID and AWS secret access key are valid, i.e. correctness
	b. check if AWS session token is valid (i.e. correctness and "fresh")

OIDC SSO:
1. Authenticate and register device to SSO start-url to get its token.
2. Create SSO token cache for OIDC connection -> `~/.aws/sso/cache/<cachefile>.json`
3. Create AWS config file, containing the AWS profile name and its session -> `~/.aws/config`
4. Create AWS credential file -> `~/.aws/credentials`

### Conclusion
<TBC>
